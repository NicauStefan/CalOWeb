<!DOCTYPE html>

<body>
<script src="lib/hello.js"></script>
<script src="lib/hello.then.js"></script>
<script src="lib/modules/windows.js"></script>
<script src="lib/modules/facebook.js"></script>
<script src="lib/modules/google.js"></script>
<script src="lib/moment.js"></script>

<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="./dpd.js"></script>


<button id='google' onclick=" ;">google2</button>&nbsp;
<button id='logout' onclick="logout('google');">Logout</button><br>
Go to <button id='info' onclick=" goToInfo();">hbe info</button><br>
Go to <button id='goal' onclick=" goToGoal();">goal</button><br>
Go to <button id='status' onclick="goToStatus();">status</button><br>
Go to <button id='consumables' onclick="goToConsumables();">add consumables</button><br>
Go to <button id='charts' onclick="goToCharts();">charts</button><br>
<br>

<p id="dateToday"></p>
<p id="weightToday"></p>
<p id="dateToday"></p>



<script>
var loginID;
var online = function(session){
	var current_time = (new Date()).getTime() / 1000;
	return session && session.access_token && session.expires > current_time;
};

var fb = hello( "facebook" ).getAuthResponse();
var wl = hello( "google" ).getAuthResponse();


if(!(online(fb) || 
	online(wl)))
{
	alert("not logged into any account please login"+online(fb) + " and "+ online(wl));
	window.location.href='./index.html';

}


</script>

<script>
</script>


<script>
hello.on('auth.login', function(r){
	
	// call user information, for the given network

	
	hello( r.network ).api( '/me' ).then( function(p){
		//console.log("function input is:"+p.thumbnail);
		console.log(p);
		console.log(p.id);
		var label = document.getElementById(r.network);
		label.innerHTML = "<img src='"+ p.thumbnail + "' width=24/>Connected to "+ r.network+" as " + p.name;
		console.log("HI");
		loginID = p.id;

		//__Check if both GOAL and INFO are set; if not redirect to them
		dpd.users.get({"username":loginID},function(result1){
			//console.log("i am ",loginID," HI",result1);
			if(!result1)
			{
				//__Failed Querrying users
				console.log("cannot conect to database for user");
				//window.location.href='./index.html';
				return;
			}
			if(result1[0])
			{
				if(!result1[0].hasInfo)
					window.location.href='./protoP2getData.html';

				if(!result1[0].hasGoal)
					window.location.href='./protoP3setGoal.html';

			}
			else
			{
				console.log("~~ERROR:no such USER exists in db");
			}
			
		});		
	});
});
</script>

<script>

	dpd.usergoal.get({"userID":loginID,"active":true}, function (result2) {
		if(!result2)
		{
			console.log("ERROR with getting user from db exiting...");
			return;
		}
		if(!result2[0])
		{//no active goals
			console.log("no active goal found");
			window.location.href='./protoP3setGoal.html';
		}
		currentTime = moment().format('YYYY-MM-DD');
		
		dpd.userhbe.get({"userID":loginID}, function (result) {
			console.log("Querrying USERHBE");
			if(!result || !result[0])
			{
				//__Failed Querrying userHBE
				console.log("cannot conect to database/user dosen't exist");
				return;
				//window.location.href='./index.html';
			}
			console.log("~~~GET~~~For userHBE~:",result);
			dpd.userhistory.get({"userID":loginID},function(result1){
				if(!result1)
					console.log("ERRROR-CANNOT ACCESS DB");

				//exercises 			
				
				var weightBMR;
				var BMR_const;
				var BMR;
				
				var gc_initial = result[0].weight;// in KG
				var gc_curent = gc_initial;
				if( result[0].gender == false )
				{//female
					BMR_const = 447.593 + (3.098 * result[0].height) - (4.330 * result[0].age);
					weightBMR = 9.247;
				}
				else			
				{//male
					BMR_const = 88.362 + (4.799 * result[0].height) - (5.677 * result[0].age);
					weightBMR = 13.397;
				}
				
				var currentIntake;
				var	calDelta;
				var exercises = result[0].exercises;
				// sorted by date?
				for(var i = 0 ; i < result1.length; i++)
				{
					BMR = BMR_const + gc_curent*weightBMR;
					if( exercises === "1" )
						currentIntake = BMR * 1.2;
					else if( exercises ==="2" )
						currentIntake = BMR * 1.375;
					else if( exercises ==="3" )
						currentIntake = BMR * 1.55;
					else if( exercises ==="4" )
						currentIntake = BMR * 1.725;
					else if( exercises ==="5" )
						currentIntake = BMR * 1.9;
					else
						console.log("ERROR bad variable exerecises");
						
					if(currentIntake == result1[i].amount)
						gc_curent = gc_curent;
					else if (currentIntake < result1[i].amount) 
						{
							//am adus in corp mai mult decat necesaru
							calDelta = result1[i].amount - currentIntake;
							gc_curent += (calDelta * 0.2958)/1000;//calDelta to grams, then to kg
						}
						else
						{
							//am adus in corp mai putin decat necesaru
							calDelta = currentIntake - result1[i].amount;
							gc_curent -= (calDelta * 0.2958)/1000;//calDelta to grams, then to kg
						}
						console.log("For day:",result1[i].date," deduced weight:",gc_curent);
						
				}
				//compar greutatea dedusa cu greutatea initiala
				//USERGOAL
				// today -> deduced weight -> you have this much more to gain/loose/maitain for the next X days
				// on the right path?	compare initial weight to the deduced weight
				var goal_type = result2[0].goalDeltaWeight;
				var goal_weight = Math.round(result2[0].goalWeightKilograms);
				var deduced_weight = Math.round(gc_curent);
				console.log("	Comparing Final deduced weight in KG:",deduced_weight," with goal weight in KG:",goal_weight)
				
				$("#dateToday").text("Today is "+currentTime);
				
				
				if( goal_type > 0 )
				{// gain
					
					if( deduced_weight > goal_weight )
					{//eats too much
						
					}
					else if()
					else
				}
				else if(goal_type == 0)
				{// maintain
					
				}
				else 
				{
					
				}
				
				$("#weightToday").text("Your current weight should be :"+deduced_weight+"  ");
				
				});
			
			});

		});
</script>

<script>
	
function logout(network){
	hello( network ).logout(function(e){
		console.log("logged out",e);
		window.location.href='./index.html';
	});
}	
	
</script>

<script>
	
	
	dpd.objcal.get(function (result, err) {
		if(err) return console.log(err);
		console.log(result);
		
		var key;
		var value;		
		var food = $("#dateToday");
		
		for(var i = 0 ; i < result.length ;i++)
		{
			key = result[i].id;
			value = result[i].name;
			food.append($("<option></option>").attr("value",key).text(value));
		}
	});
</script>


<script>

</script>


<script>
//redirects
	var goToInfo = function(){
		window.location.href='./page2UserInfo.html';
	};

	var goToGoal = function(){
		window.location.href='./page3SetGoal.html';
	};

	var goToStatus = function(){
		window.location.href='./page6status.html';
	};

	var goToConsumables = function(){
		window.location.href='./page5AddFood.html';
	};

	var goToCharts = function(){
		window.location.href='./page8charts.html';
	};	
	
</script>

<script>

hello.init(
//	CLIENT_IDS,
	{google   : '211022602923-pq5hf5f11nsgko5rbr0upna9havrko98.apps.googleusercontent.com'}
	,
	{
		scope: 'email',
		//redirect_uri:'redirect.html'
		redirect_uri:'http://localhost:2403/hello.js-master/redirect.html'
	}
);
</script>

</body>