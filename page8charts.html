<!DOCTYPE html>

<body>
<script src="lib/hello.js"></script>
<script src="lib/hello.then.js"></script>
<script src="lib/modules/windows.js"></script>
<script src="lib/modules/facebook.js"></script>
<script src="lib/modules/google.js"></script>
<script src="lib/moment.js"></script>
<script src="lib/Chart.js"></script>

<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="./dpd.js"></script>

<button id='google' onclick=" ;">google2</button>
<button id='goal' onclick=" ;">goal</button>
<button id='hist' onclick=" ;">histogram</button>
<button id='advice' onclick=" ;">advice</button>

<button id='logout' onclick="logout('google');">Logout</button>

<input type="number" name="milig" min="1" max="3000" value="1" id="quatiy">
<label for="Range">Food:</label>
	<select name="Rng" id="Range">
	</select>
<br>
<button id='save' onclick=" saveDayCal();">save</button>


<script>
var loginID;
var online = function(session){
	var current_time = (new Date()).getTime() / 1000;
	return session && session.access_token && session.expires > current_time;
};

var fb = hello( "facebook" ).getAuthResponse();
var wl = hello( "google" ).getAuthResponse();

//alert(( online(fb) ? "Signed":"Not signed") + " into FaceBook, " + ( online(wl) ? "Signed":"Not signed")+" into Google");
if(!(online(fb) || 
	online(wl)))
{//  http://localhost:2403/hello.js-master/protoPage2.html
	alert("not logged into any account please login"+online(fb) + " and "+ online(wl));
	window.location.href='./index.html';

}


</script>

<script>
</script>


<script>
hello.on('auth.login', function(r){
	
	// call user information, for the given network

	
	hello( r.network ).api( '/me' ).then( function(p){
		//console.log("function input is:"+p.thumbnail);
		console.log(p);
		console.log(p.id);
		var label = document.getElementById(r.network);
		label.innerHTML = "<img src='"+ p.thumbnail + "' width=24/>Connected to "+ r.network+" as " + p.name;
		console.log("HI");
		loginID = p.id;

		//__Check if both GOAL and INFO are set; if not redirect to them
		dpd.users.get({"username":loginID},function(result1){
			//console.log("i am ",loginID," HI",result1);
			if(!result1)
			{
				//__Failed Querrying users
				console.log("cannot conect to database for user");
				//window.location.href='./index.html';
				return;
			}
			if(result1[0])
			{
				if(!result1[0].hasInfo)
					window.location.href='./protoP2getData.html';

				if(!result1[0].hasGoal)
					window.location.href='./protoP3setGoal.html';

			}
			else
			{
				console.log("~~ERROR:no such USER exists in db");
			}
			
		});		
	});
});
</script>

<script>
</script>

<script>
	
function logout(network){
	hello( network ).logout(function(e){
		console.log("logged out",e);
		window.location.href='./index.html';
	});
}	
	
</script>

<script>
	
	
	dpd.objcal.get(function (result, err) {
		if(err) return console.log(err);
		console.log(result);
		
		var key;
		var value;		
		var food = $("#Range");
		
		for(var i = 0 ; i < result.length ;i++)
		{
			key = result[i].id;
			value = result[i].name;
			food.append($("<option></option>").attr("value",key).text(value));
		}
	});
</script>
<script>
	var saveDayCal = function(){
		
		var currentTime = moment().format('YYYY-MM-DD');
		var quatiy = $("#quatiy").val();
		var food = $("#Range").val();
		
		dpd.usergoal.get({"userID":loginID}, function (result) {
			console.log("Querrying USERGOAL",result[0]);

			dpd.userhistory.get({"userID":loginID,"day":currentTime},function(result){
				if(!result)
					console.log("ERRROR-CANNOT ACCESS DB");
				if(!result[0])
				{
					dpd.userhistory.post(
					{
						"userID":loginID,
						"day":currentTime,
						"amount":quatiy
					}
					, function(result, err) {
						  if(err) return console.log(err);
						  console.log("~~~POST~~~For userHistory~:",result, result.id);
						  
					});	
				}
				else
				{
					var amountTotal = result[0].amount + parseInt(quatiy);
					dpd.userhistory.put(result[0].id,
					{
						"userID":loginID,
						"day":currentTime,
						"amount":amountTotal
					}
					, function(result, err) {
						  if(err) return console.log(err);
						  console.log("~~~POST~~~For userHistory~:",result, result.id);
						  
					});					
				}
				
			});
			
			
		});	
		
		console.log("going with ",quatiy," and ",food);
	};
</script>

<script>

hello.init(
//	CLIENT_IDS,
	{google   : '211022602923-pq5hf5f11nsgko5rbr0upna9havrko98.apps.googleusercontent.com'}
	,
	{
		scope: 'email',
		//redirect_uri:'redirect.html'
		redirect_uri:'http://localhost:2403/hello.js-master/redirect.html'
	}
);
</script>

</body>